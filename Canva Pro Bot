const express = require("express");
const bodyParser = require("body-parser");
const axios = require("axios");

const app = express();
app.use(bodyParser.json());

const token = "canva-pro-bot"; // Replace with your token
const phoneNumberId = "614678168398708"; // Replace with your Phone Number ID

const sendMessage = async (to, message) => {
  await axios.post(`https://graph.facebook.com/v18.0/${phoneNumberId}/messages`, {
    messaging_product: "whatsapp",
    to,
    text: { body: message }
  }, {
    headers: { Authorization: `Bearer ${token}` }
  });
};

app.post("/webhook", async (req, res) => {
  const entry = req.body.entry?.[0];
  const changes = entry?.changes?.[0];
  const value = changes?.value;

  const message = value?.messages?.[0];
  const from = message?.from;
  const type = message?.type;

  if (message) {
    let userMsg = "";
    if (type === "text") {
      userMsg = message.text.body.toLowerCase();
    } else if (type === "image") {
      await sendMessage(from, `Thank you! âœ…\nYour Canva Pro access is now active. Enjoy designing with premium features! ðŸŽ¨\nLet me know if you need any help. ðŸš€`);
      return res.sendStatus(200);
    }

    // Flow 1
    if (userMsg.includes("hello") || userMsg.includes("interested in canva pro") || userMsg.includes("send info")) {
      await sendMessage(from, `Hi! ðŸ‘‹ Get Canva Pro lifetime access on your email address\n\nðŸ’¡ Choose an option below:\n\n1ï¸âƒ£ What is the price?\n2ï¸âƒ£ How to Buy?\n3ï¸âƒ£ Payment methods?\n4ï¸âƒ£ Customer Support?\n\nðŸš¨ Limited time offer â€” Hurry up!`);
    }

    else if (userMsg.includes("1") && !userMsg.includes("bonus")) {
      await sendMessage(from, `ðŸ’° Total Rs. 250 (payment after activation)`);
    }

    else if (userMsg.includes("2") && !userMsg.includes("bonus")) {
      await sendMessage(from, `ðŸ“§ Send your email\nðŸš€ Get access, then make the payment\n\n*Note:* If your Canva Pro has been activated, so kindly type "Payment Details" & send.`);
    }

    else if (userMsg.includes("3") || userMsg.includes("payment method")) {
      await sendMessage(from, `âœ… Easypaisa\nâœ… JazzCash`);
    }

    else if (userMsg.includes("4") || userMsg.includes("support")) {
      await sendMessage(from, `ðŸ’¬ Chat with us anytime!`);
    }

    else if (userMsg.includes("payment details")) {
      await sendMessage(from, `ðŸ’¡ Choose an option below:\n\nâœ… Easypaisa\nâœ… JazzCash\n\nPlease type an option like: *Easypaisa*, *JazzCash*.`);
    }

    else if (userMsg.includes("easypaisa")) {
      await sendMessage(from, `*Bank Name:* Easypaisa\n*Account Number:* 03462410880\n*Account Name:* Samina Muhammad Yaseen\n\n*Note:* If you done the payment, so send the screenshot.`);
    }

    else if (userMsg.includes("jazzcash")) {
      await sendMessage(from, `*Bank Name:* JazzCash\n*Account Number:* 03216027311\n*Account Name:* Samina Muhammad Yaseen\n\n*Note:* If you done the payment, so send the screenshot.`);
    }

    // Flow 2 with Bonus
    else if (userMsg.includes("bonus") || userMsg.includes("free resources")) {
      await sendMessage(from, `Hi! ðŸ‘‹ Get Canva Pro lifetime access on your email address\n\nðŸ’¡ Choose an option below:\n\n1ï¸âƒ£ What is the price?\n2ï¸âƒ£ Where are the Bonus Items?\n3ï¸âƒ£ How to Buy?\n4ï¸âƒ£ Payment methods?\n5ï¸âƒ£ Customer Support?\n\nðŸš¨ Limited time offer â€” Hurry up!`);
    }

    else if (userMsg.includes("1") && userMsg.includes("bonus")) {
      await sendMessage(from, `ðŸ’° Total Rs. 650 (payment after activation)`);
    }

    else if (userMsg.includes("2") && userMsg.includes("bonus")) {
      await sendMessage(from, `*Here are the 5 Exclusive Bonus Items ðŸ‘‡*\n\nðŸŽ¯ 5000+ Advanced ChatGPT Prompts\nðŸŽ¥ 100+ Paid YouTube Courses\nðŸ“š 100+ Ebooks Worth Rs. 100K\nðŸ›ï¸ Shopify Premium Themes Pack\nðŸŽ¨ 5000+ Canva Templates`);
    }

    else if (userMsg.includes("image")) {
      await sendMessage(from, `Thank you! âœ…\nYour Canva Pro access is now active. Enjoy designing with premium features!\n\nYouâ€™ve also received:\nâ€¢ 5000+ ChatGPT Prompts\nâ€¢ 100+ Paid YouTube Courses\nâ€¢ 100+ Ebooks worth 100k\nâ€¢ Shopify Themes Pack\nâ€¢ 5000+ Canva Templates\n\nLet me know if you need any help.`);
    }
  }

  res.sendStatus(200);
});

// Meta verification route
app.get("/webhook", (req, res) => {
  const verify_token = "canvaprobot";
  const mode = req.query["hub.mode"];
  const token = req.query["hub.verify_token"];
  const challenge = req.query["hub.challenge"];

  if (mode && token && token === verify_token) {
    res.status(200).send(challenge);
  } else {
    res.sendStatus(403);
  }
});

app.listen(3000, () => console.log("Bot is running"));
